<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">

<title>alinantico Analytics</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body{
  font-family: Arial;
  background:#f4f4f4;
  padding:20px;
}

h1{text-align:center;}

.box{
  background:white;
  padding:20px;
  margin:15px 0;
  border-radius:10px;
}

select,input{
  padding:6px;
  margin:5px;
}

button{
  padding:8px 15px;
  background:#333;
  color:white;
  border:none;
  border-radius:5px;
}

</style>
</head>

<body>

<h1>ðŸ“Š alinantico Analytics</h1>

<div class="box">

<input type="file" id="fileInput">

<br><br>

<label>X (Categoria):</label>
<select id="xSelect"></select>

<label>Y (Valore):</label>
<select id="ySelect"></select>

<label>Grafico:</label>
<select id="typeSelect">
  <option value="bar">Barre</option>
  <option value="line">Linea</option>
  <option value="pie">Torta</option>
  <option value="doughnut">Ciambella</option>
</select>

<button onclick="genera()">Genera</button>

</div>

<div class="box">
<canvas id="grafico"></canvas>
</div>

<script>

let dati=[];
let chart=null;

document.getElementById("fileInput").addEventListener("change",loadFile);

function loadFile(e){

const file=e.target.files[0];
const reader=new FileReader();

reader.onload=function(x){

const data=new Uint8Array(x.target.result);
const wb=XLSX.read(data,{type:"array"});
const sh=wb.Sheets[wb.SheetNames[0]];
dati=XLSX.utils.sheet_to_json(sh);

preparaSelect();

};

reader.readAsArrayBuffer(file);
}

function preparaSelect(){

const cols=Object.keys(dati[0]);

let x=document.getElementById("xSelect");
let y=document.getElementById("ySelect");

x.innerHTML="";
y.innerHTML="";

cols.forEach(c=>{

let o1=document.createElement("option");
o1.value=c;
o1.text=c;

let o2=o1.cloneNode(true);

x.appendChild(o1);
y.appendChild(o2);

});
}

function genera(){

let xCol=xSelect.value;
let yCol=ySelect.value;
let tipo=typeSelect.value;

let map={};

dati.forEach(r=>{

let k=r[xCol];
let v=Number(r[yCol]);

if(!k || !v)return;

map[k]=(map[k]||0)+v;

});

let labels=Object.keys(map);
let values=Object.values(map);

if(chart)chart.destroy();

chart=new Chart(
document.getElementById("grafico"),
{
type:tipo,
data:{
labels:labels,
datasets:[{
data:values,
backgroundColor:[
"#4CAF50","#2196F3","#FF9800",
"#E91E63","#9C27B0","#00BCD4"
]
}]
},
options:{responsive:true}
});
}

</script>

</body>
</html>
